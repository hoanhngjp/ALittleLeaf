name: CI - Build and Test

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create .env file
      run: echo "MSSQL_SA_PASSWORD=${{ secrets.MSSQL_SA_PASSWORD }}" > .env

    - name: Build Docker Images
      run: docker compose build

    # Sá»¬A: docker compose
    - name: Start Database Container
      run: docker compose up -d db

    - name: Wait for SQL Server
      run: sleep 30s

    - name: Initialize Database
      run: |
        docker exec sqlserver /opt/mssql-tools18/bin/sqlcmd \
          -S localhost \
          -U sa \
          -P "${{ secrets.MSSQL_SA_PASSWORD }}" \
          -C \
          -i /docker-entrypoint-initdb.d/ALittleLeaf.sql

    - name: Run Unit Tests
      run: docker compose --profile testing up --exit-code-from unit-tests unit-tests

    - name: Teardown
      if: always()
      run: docker compose down